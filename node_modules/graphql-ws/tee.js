var DuplexBufferStream = require('duplexbufferstream');
var fs = require('fs');
const { EventEmitter } = require('events');

tee = fs.createReadStream('/home/ykiruha/Downloads/X-Men.Apocalypse.2016.x264.BDRip.(1080p).ExKinoRay.mkv');

//var tee = new DuplexBufferStream();
//process.stdin.pipe(tee);

const events = new EventEmitter();

let dataRevision = 0;
let lastRevision = null;

tee.on('readable', ()=> dataRevision++);
tee.on('error', ()=>console.log('error'))
tee.on('end', ()=>console.log('end'))

function readChunk() {
	lastRevision = dataRevision;
	var chunk;
	let read = 0;
	while((chunk = tee.read(30 * 1024 * 1024)) !== null) {
		read += chunk.length;
	}
	console.log(read);
	setTimeout(() => readall(), 1000);
}

function readall() {
	if (dataRevision !== lastRevision) {
		readChunk();
	} else
		events.once('readable', readChunk);
}

readall();

setInterval(()=>{console.log(process.memoryUsage());}, 1000);
